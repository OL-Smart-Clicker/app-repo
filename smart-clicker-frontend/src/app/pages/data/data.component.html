<div class="container mx-auto p-3 w-full">
    <!-- Header -->
    <div class="mb-2">
        <h1 class="text-2xl font-bold text-gray-900 mb-1">Data Overview</h1>
        <p class="text-gray-600 text-sm">View data for your organization</p>
    </div>
    <div *ngIf="loading" class="flex justify-center items-center py-12">
        <app-spinner></app-spinner>
    </div>
    <div *ngIf="!loading" class="max-w-full mx-auto p-4">
        <div class="flex flex-col md:flex-row gap-4 justify-center items-center mb-6">
            <div class="flex flex-col md:flex-row gap-2 items-center">
                <label for="startDate" class="font-medium">Start date:</label>
                <input id="startDate" type="date" [(ngModel)]="startDate"
                    class="border border-primary-blue focus:border-secondary-blue focus:ring-2 focus:ring-blue-200 rounded px-3 py-2 shadow-sm transition placeholder:text-gray-400 text-sm outline-none" />
            </div>
            <div class="flex flex-col md:flex-row gap-2 items-center">
                <label for="endDate" class="font-medium">End date:</label>
                <input id="endDate" type="date" [(ngModel)]="endDate"
                    class="border border-primary-blue focus:border-secondary-blue focus:ring-2 focus:ring-blue-200 rounded px-3 py-2 shadow-sm transition placeholder:text-gray-400 text-sm outline-none" />
            </div>
            <button (click)="loadClickerData()"
                class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 transition">
                <div class="flex align-middle">
                    <ng-icon [svg]="icons.heroArrowPath" />
                    <p class="ml-2">Refresh Data</p>
                </div>
            </button>
            <button (click)="downloadCSV()"
                class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 transition">
                <div class="flex align-middle">
                    <ng-icon [svg]="icons.heroArrowDownTray" />
                    <p class="ml-2">Export CSV</p>
                </div>
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow p-4 min-h-[120px] flex flex-col items-center justify-center">
                <div class="text-lg font-semibold mb-3 text-primary-blue">Floor Plan Overview</div>
                <ng-container *ngIf="floorPlan">
                    <div class="relative flex items-center justify-center w-full h-full">
                        <img #floorImg [src]="floorPlan" alt="Floor Plan"
                            class="max-h-64 object-contain rounded border block mx-auto"
                            (load)="onDetailsImageLoad(floorImg)" />
                        <ng-container *ngIf="anchors">
                            <div *ngFor="let anchor of anchors; let i = index"
                                class="absolute w-5 h-5 bg-blue-500 rounded-full border-2 border-white flex items-center justify-center anchor-dot z-100"
                                [style.left.px]="anchor.x * detailsImageWidth - 10 + ((floorImg.offsetLeft || 0))"
                                [style.top.px]="anchor.y * detailsImageHeight - 10 + ((floorImg.offsetTop || 0))">
                                <span class="text-xs text-white">{{anchor.id}}</span>
                            </div>
                            <div *ngFor="let pos of trilateratedPositions; let idx = index"
                                class="absolute w-3 h-3 bg-red-600 rounded-full border-2 border-white flex items-center justify-center z-200 animate-pulse"
                                [style.left.px]="pos.x - 6 + ((floorImg.offsetLeft || 0))"
                                [style.top.px]="pos.y - 6 + ((floorImg.offsetTop || 0))">
                            </div>
                        </ng-container>
                    </div>
                </ng-container>
                <span *ngIf="!floorPlan" class="text-secondary-blue">No floorplan uploaded.</span>
            </div>
            <div class="bg-white rounded-xl shadow p-6 min-h-[120px] flex flex-col items-center justify-center">
                <div class="text-lg font-semibold mb-3 text-primary-blue">Click Activity Timeline</div>
                <app-timeline-chart [data]="clickerData"></app-timeline-chart>
            </div>
            <div class="flex flex-col gap-4 w-full">
                <div class="bg-white rounded-xl shadow p-4 flex flex-col items-center justify-center">
                    <span class="text-lg font-semibold text-primary-blue">Total Clicks</span>
                    <span class="text-2xl font-bold text-gray-800 mt-2">{{ totalClicks }}</span>
                </div>
                <div class="bg-white rounded-xl shadow p-4 flex flex-col items-center justify-center">
                    <span class="text-lg font-semibold text-primary-blue">Busiest Day</span>
                    <span class="text-2xl font-bold text-gray-800 my-2">{{ busiestLabel }}</span>
                    <span class="text-sm text-gray-500">{{ busiestCount }} clicks</span>
                </div>
                <div class="bg-white rounded-xl shadow p-4 flex flex-col items-center justify-center">
                    <span class="text-lg font-semibold text-primary-blue">Avg. Time Between Clicks</span>
                    <span class="text-2xl font-bold text-gray-800 mt-2">{{ avgTimeBetweenClicks }}</span>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow p-6 mt-4">
            <span class="text-lg font-semibold text-primary-blue block mb-2">Clicker Data</span>
            <div *ngIf="clickerData.length > 0" class="overflow-x-auto max-h-96">
                <table class="min-w-full text-sm text-left border">
                    <thead class="bg-gray-100 sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-2 border-b">Device ID</th>
                            <th class="px-4 py-2 border-b">Timestamp</th>
                            <th class="px-4 py-2 border-b">Distances</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let row of clickerData">
                            <td class="px-4 py-2 border-b">{{ row.deviceId || row.id }}</td>
                            <td class="px-4 py-2 border-b">{{ row.timestamp * 1000 | date:'yyyy-MM-dd HH:mm:ss' }}</td>
                            <td class="px-4 py-2 border-b">
                                <ng-container *ngIf="row.distances && row.distances.length; else noDist">
                                    <span *ngFor="let d of row.distances; let i = index">
                                        {{ d }}<span *ngIf="i < row.distances.length - 1">, </span>
                                    </span>
                                </ng-container>
                                <ng-template #noDist><span class="text-gray-400">-</span></ng-template>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div *ngIf="clickerData.length === 0">
                <span class="text-secondary-blue">No data.</span>
            </div>
        </div>
    </div>
</div>